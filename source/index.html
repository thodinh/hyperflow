@{layout('')}

<!DOCTYPE html>
<html>
<head>
	<title>@{config.name} - Flow @{R.versiontitle}</title>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=11" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
	<meta name="robots" content="all,follow" />
	<link rel="apple-touch-icon" href="@{R.url}img/icon.png" type="image/png" />
	<link rel="icon" href="@{R.url}img/icon.png" type="image/png" />
	@{if R.sharedfiles}
	<link href="/css/dep.min.css" rel="stylesheet" type="text/css" />
	@{fi}
	<link href="@{R.url}default.css" rel="stylesheet" type="text/css" />
	@{if R.sharedfiles}
	<script src="/js/dep.min.js"></script>
	@{fi}
	<script src="@{R.url}default.js"></script>
	@{import('head')}
</head>
<body data---="exec,binder"@{if R.dark} class="themedark"@{fi}>

	@{json(user, 'userdata')}

	<div data---="LAZY autocomplete"></div>
	<div data---="LAZY calendar__null__days:@(SU,MO,TU,WE,TH,FR,SO);months:@(January,February,March,April,May,June,July,August,September,October,November,December);today:@(Set date to today);firstday:0"></div>
	<div data---="LAZY message__null__button:@(Close)"></div>
	<div data---="LAZY snackbar__null__button:@(Dismiss)"></div>
	<div data---="LAZY directory"></div>
	<div data---="LAZY timepicker"></div>
	<div data---="LAZY datepicker__null__days:@(SU,MO,TU,WE,TH,FR,SO);months:@(January,February,March,April,May,June,July,August,September,October,November,December);today:@(Set date to today);firstday:0"></div>
	<div data---="LAZY contextmenu"></div>
	<div data---="LAZY tooltip"></div>
	<div data---="menu"></div>
	<div data---="confirm"></div>
	<div data---="features__null__placeholder:@(Search feature ...)"></div>
	<div data---="colorpicker"></div>
	<div data---="loading" class="ui-loading ui-loading-firstload"></div>
	<div data---="shortcuts"></div>
	<div data---="websocket__null__@{if F.is4}encoder:false@{else}encoder:true@{fi};url:@{R.socket.replace(/\:/g, '\\:')}?designer=1&token=@{query.token}&baa=@{R.baa}"></div>

	<div id="success"><span class="fa fa-refresh fa-spin"></span></div>

	<div class="panel">

		<div class="panel-resize-handle"></div>
		<section class="tabs tabs-panel">
			<nav>
				<button class="exec" data-path="common.panel" data-value="'info'" data-bind="common.panel__.selected:value=='info'"><i class="fa fa-info-circle"></i>@(Info)</button>
				<button class="exec" data-path="common.panel" data-value="'debug'" data-bind="common.panel__.selected:value=='debug'">@(Console)</button>
				<button class="exec" data-path="common.panel" data-value="'errors'" data-bind="common.panel__.selected:value=='errors'"><i class="fa fa-bug" data-bind="common.errors__.red:value && value.length"></i>@(Errors)</button>
				<button class="exec" data-path="common.panel" data-value="'traffic'" data-bind="common.panel__.selected:value=='traffic'"><i class="fa fa-tasks"></i>@(Traffic)</button>
			</nav>
		</section>
		<div class="hidden noscrollbar" data-bind="common.panel__show:value=='info'">
			<div class="padding">
				<div class="hidden" id="info-panel-notes">
					<div class="b" style="font-size:10px;margin-bottom:8px"><i class="fa fa-file-text-o mr5"></i>@(NOTES)</div>
					<div class="mt5 md"></div>
				</div>
				<div id="info-panel"></div>
			</div>
		</div>

		<div id="panel-notification">
			<label><i class="fa fa-bell"></i>@(Flow notification)</label>
			<div></div>
		</div>

		<div class="hidden body-errors" data-bind="common.panel__show:value=='errors'">

			<div class="padding npb npt mt10">
				<span class="link red fs11 exec" data-exec="#errors.clear"><i class="fa fa-times mr5"></i>@(Clear all errors)</span>
				<hr class="mt10 nmb" />
			</div>

			<div class="noscrollbar">
				<div data---="repeater__common.errors">
					<script type="text/html">
						<div class="erroroutput">
							<div class="erroroutput-name"><i class="fa fa-square mr5" style="color:{{ color }}"></i><b>{{ name }}</b> / {{ tab }}</div>
							<div class="erroroutput-errors">
							{{ foreach m in errors }}
								<div>
									<div class="gray">@({{ m.count }}x errors) / {{ m.date | format('@(yyyy-MM-dd HH:mm:ss)') }}</div>
									<div class="keepbreaks">{{ m.error }}</div>
								</div>
							{{ end }}
							</div>
						</div>
					</script>
				</div>
			</div>
		</div>

		<div class="hidden body-debug" data-bind="common.panel__show:value=='debug'">
			<div style="padding:15px 15px 0">
				<span class="link red fs11 exec" data-exec="#debug.clear" style="float:right;margin-top:2px"><i class="fa fa-times mr5"></i>@(Clear console)</span>
				<div data---="checkbox__common.beautify">@(Beautify)</div>
				<hr class="nmb" style="margin-top:15px" />
			</div>
			<div id="body-debug-output" class="noscrollbar"></div>
		</div>

		<div class="hidden body-traffic" data-bind="common.panel__show:value=='traffic'">

			<div class="body-traffic-heading">
				<div><span data-bind="flow.traffic.memory__html:value" class="b fr">...</span><i class="fa fa-microchip mr5"></i>@(Memory consumption:)</div>
				<div><span data-bind="flow.traffic.counter__html:(value || 0).format(0) + 'x'" class="b fr">...</span><i class="fa fa-calculator mr5"></i>@(Count of messages:)</div>
				<div><span data-bind="common.onlineusers__html:(value || 0).format(0) + 'x'" class="b fr">...</span><i class="fa fa-users mr5"></i>@(Online users:)</div>
				<div class="checkboxes">
					<div data---="checkbox__common.animations" class="b">@(Show real-time traffic visualizer)</div>
					<div data---="checkbox__common.traffictab">@(Show traffic from the current tab)</div>
				</div>
			</div>

			<div class="noscrollbar">
				<div class="traffic-container b" style="margin-bottom:5px" data-bind="common.trafficsort__template:.sort">
					<script type="text/html">
						<div class="traffic-value sort exec" data-exec="trafficsort" data-name="outputs">{{ value | trafficsort('outputs') }}@(Output)</div>
						<div class="traffic-value sort exec" data-exec="trafficsort" data-name="inputs">{{ value | trafficsort('inputs') }}@(Input)</div>
						<div class="traffic-value sort exec" data-exec="trafficsort" data-name="duration" title="@(Average processing time)">{{ value | trafficsort('duration') }}@(Time)</div>
						<div class="traffic-name sort exec" data-exec="trafficsort" data-name="name">{{ value | trafficsort('name') }}@(Component)</div>
					</script>
				</div>
				<div data---="repeater__flow.traffic">
					<script type="text/html">
						<div class="traffic-container">
							<div class="traffic-value{{ if output > 59 }} red{{ fi }}">{{ outputc }}</div>
							<div class="traffic-value{{ if input > 59 }} red{{ fi }}">{{ inputc }}</div>
							<div class="traffic-value">{{ if isduration }}{{ duration | duration }}{{ else }}---{{ fi }}</div>
							<div class="traffic-name gray exec" data-id="{{ id }}" data-exec="highlightcomponent">{{ name }}</div>
						</div>
					</script>
				</div>
			</div>
		</div>
	</div>
	<div class="mainmenu body-components">

		<section class="tabs tabs-controls">
			<nav>
				<button title="@(Apply the current Flow)" class="exec highlight" data-exec="#flow.apply"><i class="fa fa-play-circle"></i>@(APPLY)</button>
				<button title="@(Pause / Play)" class="exec onlyicon" data-exec="flowpause" data-bind="flow.paused__change:flowpausestyle"><i class="fa"></i></button>
				<button title="@(Settings)" class="exec onlyicon" data-exec="settings_menu"><i class="fa fa-chevron-down"></i></button>
			</nav>
		</section>

		<div class="components-search-padding">
			<div data---="textbox__common.search__placeholder:@(Search components ...);type:search"></div>
		</div>

		<div data---="search__common.search__selector:li">
			<div class="components-container">
				<div class="noscrollbar">
					<ul data---="repeatergroup__common.components__group:group" class="components">
						<script type="text/html">
							<li draggable="true" class="component" data-id="{{ id }}" data-search="{{ name }}">
								<div><i class="fa fa-{{ if icon }}{{ icon }}{{ else }}circle{{ fi }}" style="color:{{ color }}"></i>{{ name }}</div>
							</li>
						</script>
						<script type="text/html">
							<li class="group" data-search="">{{ group }}</li>
							{{ body | raw }}
						</script>
					</ul>
					<br />
				</div>
			</div>
		</div>
	</div>

	<div class="body body-designer">

		<div class="tabs-tools">
			<button class="exec green" data-exec="#tabs.add" title="@(New tab)"><i class="fa fa-plus"></i></button>
			<button class="exec" data-exec="showhelp" title="@(Help)"><i class="fa fa-question-circle"></i></button>
			<button class="exec" data-exec="themechanger" title="@(Change theme)"><i class="fa fa-paint-brush"></i></button>
			<button class="exec scrolling hidden" data-exec="tabscrolling" data-value="-200" title="@(Scroll tabs to right)"><i class="fa fa-chevron-left"></i></button>
			<button class="exec scrolling hidden" data-exec="tabscrolling" data-value="200" title="@(Scroll tabs to left)"><i class="fa fa-chevron-right"></i></button>
		</div>

		<div class="hidetools">
			<button class="exec" data-path="common.minimized" data-value="!common.minimized"><i class="fa fa-chevron-right" data-bind="common.minimized__.fa-chevron-left:value__.fa-chevron-right:!value"></i></button>
			<button class="exec" data-path="common.minimizedmainmenu" data-value="!common.minimizedmainmenu"><i class="fa fa-chevron-left" data-bind="common.minimizedmainmenu__.fa-chevron-left:!value__.fa-chevron-right:value"></i></button>
		</div>

		<section class="tabs tabs-flow">
			<figure class="tabs-scroller">
				<nav data---="repeater__flow.tabs">
					<script type="text/html">
						<a href="#{{ linker }}" class="tab{{ if changed }} changed{{ fi }}" data-id="{{ id }}" data-bind="common.tab__!.selected:value.id=='{{ id }}'">{{ name }}</a>
					</script>
				</nav>
			</figure>
		</section>

		<div class="designer-container">

			<div id="designerstate"></div>

			<nav id="designerbuttons">
				<button class="exec disabled" title="@(Settings)" data-exec="settings_component"><i class="fa fa-cog"></i></button>
				<button class="exec disabled" title="@(Copy component)" data-exec="#designer.copy"><i class="fa fa-file-text-o"></i></button>
				<button class="exec disabled" name="paste" title="@(Paste component)" data-exec="#designer.paste"><i class="fa fa-paste"></i></button>
				<button class="exec disabled" name="duplicate" title="@(Duplicate component)" data-exec="#designer.duplicate"><i class="fa fa-files-o"></i></button>
				<button class="exec disabled designerbuttons-remove" name="remove" title="@(Remove selection)" data-exec="#designer.remove"><i class="fa fa-times-circle"></i></button>
			</nav>

			<div id="designerzoom">
				<button class="exec" title="@(Zoom in)" data-exec="#designer.zoomin"><i class="fa fa-search-plus"></i></button>
				<button class="exec" title="@(Reset zoom)" data-exec="#designer.zoomreset"><i class="fa fa-unsorted"></i></button>
				<button class="exec" title="@(Zoom out)" data-exec="#designer.zoomout"><i class="fa fa-search-minus"></i></button>
			</div>

			<div class="designer-scrollbar">
				<div class="designer-shadow-top"></div>
				<div class="designer-shadow-right"></div>
				<div class="designer-shadow-bottom"></div>
				<div class="designer-shadow-left"></div>
				<div data---="designer__flow.designer"></div>
			</div>
		</div>
	</div>

	<div data---="importer__common.form__if:tab;url:@{R.url}forms/form-tab.html;cleaner:5"></div>
	<div data---="importer__common.form__if:export;url:@{R.url}forms/form-export.html;reload:export/reload;cleaner:5"></div>
	<div data---="importer__common.form__if:import;url:@{R.url}forms/form-import.html;reload:import/reload;cleaner:5"></div>
	<div data---="importer__common.form__if:database;url:@{R.url}forms/form-database.html;cleaner:5"></div>
	<div data---="importer__common.form__if:variables;url:@{R.url}forms/form-variables.html;reload:variables/reload;cleaner:5"></div>
	<div data---="importer__common.form__if:help;url:@{R.url}forms/form-help.html;cleaner:5"></div>
	<div data---="importer__common.form2__if:components;url:@{R.url}forms/form-components.html;cleaner:5"></div>
	<div data---="importer__common.form__if:welcome;url:@{R.url}forms/intro-welcome.html;cleaner:5"></div>
	<div data---="importer__common.form__if:imported;url:@{R.url}forms/intro-imported.html;cleaner:5"></div>
	<div data---="importer__common.form__if:templates;url:@{R.url}forms/form-templates.html;cleaner:5"></div>

	<div id="flowsettings"></div>
	<div id="tmpclone"></div>

	<script>

		(function() {

			var events = {};
			var offsetX = 0;
			var panel = $('.panel');
			var noscrollbar = panel.find('.noscrollbar');
			var body = $('.body');
			var min = 340;
			var max = (WW / 1.85) >> 0;
			var ssw = SCROLLBARWIDTH();
			var old = 0;

			events.mup = function(e) {

				e.stopPropagation();
				e.preventDefault();

				var w = $(W);
				w.off('mousemove', events.mm);
				w.off('touchmove', events.tm);
				w.off('mouseup', events.mup);
				w.off('touchend', events.mup);
				var width = panel.width();
				SET('common.panelwidth', width);
			};

			events.mm = function(e) {
				e.stopPropagation();
				e.preventDefault();
				events.resize(e.pageX);
			};

			events.tm = function(e) {
				e.stopPropagation();
				e.preventDefault();
				events.resize(e.touches[0].pageX);
			};

			events.resize = function(pageX, touch) {
				var x = (WW - pageX - offsetX) >> 0;

				if (x > max)
					x = max;

				if (x < min)
					x = min;

				panel.css('width', x);
				body.css('margin-right', -x);
				noscrollbar.css('width', (x + ssw))
			};

			WATCH('common.panelwidth', function(path, w) {
				if (w !== old) {
					old = w;
					if (w < min)
						w = min;
					if (w > max)
						w = max;
					panel.width(w);
					body.css('margin-right', -w);
					noscrollbar.width(w + ssw);
				}
			});

			$('.panel-resize-handle').on('mousedown touchstart', function(e){

				e.preventDefault();
				e.stopPropagation();

				var w = $(W);
				w.on('mousemove', events.mm);
				w.on('touchmove', events.tm);
				w.on('touchend', events.mup);
				w.on('mouseup', events.mup);

				max = (WW / 1.80) >> 0;

				if (e.touches && e.touches[0])
					offsetX = $(this).offset().left - e.touches[0].pageX;
				else
					offsetX = e.offsetX;
			});

		})();

		setTimeout(function() {
			$(W).trigger('resize');
		}, 2000);

		window.user = PARSE('#userdata');
		M.environment('flow.jc');

		var MESSAGES = {};
		MESSAGES.apply = '<i class="fa fa-info-circle blue mr5"></i>@(You have to click the &quot;<b>APPLY</b>&quot; button to apply all the changes.)';

		isTOUCH && $(document.body).aclass('touch');

		MAKE('common', function() {
			this.id = 'flow';
			!this.panel && (this.panel = 'info');
			!this.minimized && (this.minimized = false);
			!this.minimizedmainmenu && (this.minimizedmainmenu = false);
			!this.tabscroll && (this.tabscroll = {});
			!this.animations && (this.animations = true);
			this.touches = false;
			this.theme === undefined && (this.theme = '@{if R.dark}dark@{fi}');
			this.updates = 0;
			this.version = +'@{R.version}';
			this.beautify === undefined && (this.beautify = true);
			this.callbacks = {};
			this.statics = {}; // cache for static content
			this.limit = @{R.limit};
			var params = READPARAMS();
			this.logging = params.debug === '1' || params.debug === 'true' || params.debug === 'on';
		});

		var flownotifications = [];
		var flownotified = false;

		CACHEPATH('common.minimized', '1 month');
		CACHEPATH('common.minimizedmainmenu', '1 month');
		CACHEPATH('common.panel', '1 month');
		CACHEPATH('common.panelwidth', '1 month');
		CACHEPATH('common.beautify', '1 month');
		CACHEPATH('common.theme', '1 month');
		CACHEPATH('common.tabscroll', '1 month');
		CACHEPATH('common.animations', '1 month');
		CACHEPATH('common.trafficsort', '1 month');
		CACHEPATH('common.traffictab', '1 month');

		$(document).on('click', '#panel-notification', function() {
			shownotifications(true);
		});

		// Hybrid devices
		$(document).on('touchstart', checktouches);

		function checktouches(e) {
			common.touches = true;
			$(document).off('touchstart', checktouches);
		}

		WATCH('common.theme', function(path, value) {
			var body = $(document.body);
			var cls = (body.attr('class') || '').match(/theme\w+/g);
			cls && body.rclass(cls.toString());
			value && body.aclass('theme' + value);
			$('#svggrid').find('image').attr('xlink:href', '{0}img/theme{1}.png'.format(NAV.url, common.theme || 'white'));
		}, true);

		WATCH('common.minimizedmainmenu', function(path, value) {
			$(document.body).tclass('mainmenu-hidden', value);
		}, true);

		var flow = {};
		var settings = {};
		var mdraggable = {};

		$('.designer-scrollbar').on('mousewheel', function() {
			setTimeout2('wheel', savescrollposition, 500);
		});

		$(document).on('touchstart', '[draggable]', function(e) {

			if (!common.touches)
				return;

			var el = $(e.target);
			var target = el.hclass('component') ? el : el.closest('.component');
			var val = target.length ? common.components.findItem('id', target.attrd('id')) : null;

			if (val) {
				val = CLONE(val);
				val.tab = common.tab.id;
			}

			mdraggable.drag = true;
			mdraggable.component = val;

			$('#tmpclone').empty();
			var clone = el.clone();
			clone.appendTo('#tmpclone');

			var t = e.originalEvent.touches[0];
			clone.css({ position: 'absolute', left: t.pageX, top: t.pageY, 'z-index': 5 });
			mdraggable.el = clone;

			val && SETTER('designer', 'dragdrop', val);
			e.stopPropagation();
		}).on('touchmove', '[draggable]', function(e) {

			if (!common.touches)
				return;

			if (mdraggable.drag) {
				var t = e.originalEvent.touches[0];
				mdraggable.x = t.pageX;
				mdraggable.y = t.pageY;
				mdraggable.el.css({ left: t.pageX, top: t.pageY });
				e.stopPropagation();
				e.preventDefault();
			}
		}).on('touchend', '[draggable]', function(e) {

			if (!common.touches || !mdraggable.drag)
				return;

			e.stopPropagation();
			mdraggable.drag = false;
			$('#tmpclone').empty();

			if (mdraggable.x < 280)
				return;

			var d = FIND('designer');
			var el = d.element;
			var off = el.offset();
			var x = mdraggable.x - off.left;
			var y = mdraggable.y - off.top;
			x += el.prop('scrollLeft');
			y += el.prop('scrollTop');
			var zoom = d.getZoom();
			EMIT('designer.add', mdraggable.component, (x - 50) / zoom, (y - 30) / zoom, false);
		}).on('dragstart', function(e) {

			if (common.touches)
				return;

			var el = $(e.target);
			var target = el.hclass('component') ? el : el.closest('.component');
			var val = target.length ? common.components.findItem('id', target.attrd('id')) : null;

			if (val) {
				val = CLONE(val);
				val.tab = common.tab.id;
			}

			if (val) {
				e.originalEvent.dataTransfer.setData('text', '1');
				SETTER('designer', 'dragdrop', val);
			}
		});

		common.changes = {};
		common.changedtabs = false;

		ON('changed', function(action, id) {
			id && (common.changes[id] = common.changes[id] || []);
			var changes = common.changes;
			switch (action) {
				case 'add':
					changes[id].push(action);
					break;
				case 'mov':
				 	// don't care if it's new component or already moved
					if (!~changes[id].indexOf('add') && !~changes[id].indexOf('mov'))
						changes[id].push(action);
					setTimeout2('change.move', saveMoved, 1000);
					break;
				case 'rem':
					if (~changes[id].indexOf('add'))
						changes[id] = undefined; // remove if not on server yet
					else
						changes[id].push(action);
					break;
				case 'add.connection':
				case 'rem.connection':
					if (!~changes[id].indexOf('add')) // don't care if it's new component, it's taken care of above
						changes[id].push('conn');
					break;
				case 'tabs':
					common.changedtabs = true;
					break;
				case 'flow.clear':
					common.changedtabs = true;
					break;
			};
		});

		ON('designer.add', function(component, x, y, is, cf, ct, toindex, duplicate, fromindex) {
			var obj = {};
			obj.component = component.id;
			obj.$component = component;
			obj.state = component.state || {};
			obj.x = x;
			obj.y = y;
			obj.tab = component.tab;
			obj.connections = {};
			obj.id = Date.now().toString();
			obj.isnew = true;
			obj.disabledio = { input: [], output: [] };

			if (typeof(component.status) === 'object')
				obj.state = { text: component.status.text, color: component.status.color };
			else
				obj.state = { text: component.status || '', color: '' };

			if (is) {
				obj.connections[0] = [ct];
				var comfrom = flow.components.findItem('id', cf);
				var comto = comfrom.connections[toindex].findItem('id', ct);
				if (comto) {
					if (obj.$component.output)
						obj.connections[0] = [CLONE(comto)];
					comto.id = obj.id;
					EMIT('changed', 'add.connection', obj.id, ct);
					EMIT('changed', 'add.connection', cf, obj.id);
					setTimeout(function() {
						EMIT('designer.refresh');
					}, 50);
				}
			}

			if (duplicate) {
				obj.options = duplicate.options;
				obj.name = duplicate.name;
				obj.notes = duplicate.notes;
				obj.color = duplicate.color;
				obj.output = duplicate.output;
				obj.tab = common.tab.id;
			}

			flow.components.push(obj);
			flow.designer.push(obj);
			!is && SETTER('designer', 'add', obj);
			EMIT('add.' + obj.component);
			setState(MESSAGES.apply);
			EMIT('changed', 'add', obj.id);
		});

		ON('designer.rem', function(ids) {

			ids && SETTER('confirm', 'confirm', '@(Are you sure you want to remove selected components?)', ['"trash-o" @(Yes)', '@(Cancel)'], function(index) {

				if (index)
					return;

				ids.wait(function(id, next){
					var instance = flow.components.findItem('id', id);
					EMIT('rem.' + instance.component, instance);
					flow.components = flow.components.remove('id', id);
					flow.designer = flow.designer.remove('id', id);
					flow.components.forEach(function(component) {
						Object.keys(component.connections).forEach(function(key) {
							var connections = component.connections[key];
							component.connections[key] = connections.remove('id', id);
							!component.connections[key].length && (delete component.connections[key]);
						});
					});

					var el = $('.node_' + id);

					EMIT('changed', 'rem', id);

					$('.node_connection').each(function() {
						var el = $(this);
						(el.attrd('from') === id || el.attrd('to') === id) && el.remove();
					});

					el.remove();
					next();
				}, function done(){
					setState(MESSAGES.apply);
					EMIT('designer.unselect');
				});
			});
		});

		ON('designer.settings', function(id) {
			var component = flow.components.findItem('id', id);
			if (component.isnew)
				showsettings(id, component.options || (component.$component.options ? CLONE(component.$component.options) : {}));
			else {
				SETTER('loading', 'show');
				SETTER('websocket', 'send', { type: 'settings', target: id });
			}
		});

		ON('designer.selectable', function(el) {
			flow.selected = el;
			$('#designerbuttons button').each(function(index) {
				var button = $(this);
				var disabled = false;
				if (el && this.name === 'duplicate' && el.$type === 'connection') {
					disabled = true;
				} else if (this.name === 'remove') {
					disabled = el == null;
				} else {
					disabled = index ? (el ? false : true) : (el && el.filter(function(sel) {
						return sel.hclass('node');
					}).length ? false : true);
					if (this.name === 'paste')
						disabled = flow.clipboard == null;
				}
				button.tclass('disabled', disabled);
			});
		});

		ON('designer.select', function(id) {
			if (!id)
				return;
			var component = flow.components.findItem('id', id);
			if (component) {
				EMIT('select.' + component.component, component);
				staticContent(component.component, 'readme', function(response) {
					EMIT('info', response || '', component.notes);
				});
			}
		});

		ON('designer.click', function(id) {
			if (!id)
				return;
			var component = flow.components.findItem('id', id);
			if (component) {
				EMIT('click.' + component.component, component);
				SETTER('websocket', 'send', { target: id, event: 'click' });
				success();
			}
		});

		ON('designer.add.connection', function(a, b) {
			setState(MESSAGES.apply);
			EMIT('changed', 'add.connection', a, b);
		});

		ON('designer.rem.connection', function(selected) {
			selected.wait(function(sel, next){
				// a, b, ti, fi
				var component = flow.components.findItem('id', sel.attrd('from'));
				if (!component)
					return;
				var connections = component.connections[sel.attrd('fromindex')];
				if (!connections)
					return;
				connections = connections.remove(function(item) {
					var is = item.index === sel.attrd('toindex') && item.id === sel.attrd('to');
					if (is)
						delete flow.connections[component.id + '#' + sel.attrd('fromindex') + '#' + item.index + '#' + item.id];
					return is;
				});

				EMIT('changed', 'rem.connection', component.id);
				component.connections[sel.attrd('fromindex')] = connections;
				!connections.length && (delete component.connections[sel.attrd('fromindex')]);
				next();

			}, function(){
				setState(MESSAGES.apply);
				setTimeout(function() {
					EMIT('designer.unselect');
				}, 1000);
			});
		});

		ON('info', function(value, notes) {
			var key = value + (notes || '').toString();
			if (common.bkreadme !== key) {
				common.bkreadme = key;
				var el = $('#info-panel');
				el.html(markdown(value, el));
				el = $('#info-panel-notes').tclass('hidden', !notes);
				notes && el.find('.md').html(markdown(notes, el));
			}
		});

		ON('debug', function(id, value, identificator, group, duration) {

			if (!id) {
				if (value) {
					flownotifications.push(value);
					shownotifications();
				}
				return;
			}

			var component = flow.components.findItem('id', id);
			if (!component)
				return;

			var el = $('#body-debug-output');
			var logs = el.find('.debugoutput');
			var tab = flow.tabs.findItem('id', component.tab);

			logs.length > 30 && $(logs.eq(logs.length - 1)).remove();

			var text;

			if (typeof(value) === 'string')
				text = '<div class="markdown">{0}</div>'.format(markdown(value, el));
			else
				text = '<pre><code class="lang-json hljs">{0}</code></pre>'.format(Tangular.helpers.encode(common.beautify ? JSON.stringify(value, null, '  ') : JSON.stringify(value)));

			el.prepend('<div class="debugoutput">{6}<div class="debugoutput-time"><div class="debugoutput-id">@(ID:) {5}</div><i class="fa fa-clock-o"></i>{0}{7}</div><div class="debugoutput-name"><i class="fa fa-square" style="color:{3}"></i>{1} / {4}</div>{2}</div>'.format(new Date().format('yyyy-MM-dd HH:mm:ss'), component.name && component.name !== component.$component.name ? ('{1}, <b>{0}</b>'.format(component.name, component.$component.name)) : component.$component.name, text, component.$component.color || 'gray', tab ? tab.name : '@(Unknown tab)', identificator === null ? '-' : identificator, (group ? ('<div class="debuggroup-name">' + group + '</div><div class="debuggroup">') : ''), duration != null ? (' <i class="fa fa-hourglass-half mr5"></i><b>' + duration.format(2) + ' s</b>') : '') + (group ? '</div>' : ''));

			setTimeout2('debug.highlight', function() {
				el.find('pre code').each(function(i, block) {
					if (!block.$processed) {
						block.$processed = true;
						hljs.highlightBlock(block);
					}
				});
				setTimeout(function() {
					el.noscrollbar(true);
				}, 300);
			}, 100);
		});

		ON('designer.refresh', function() {

			if (!flow.loaded)
				return;

			var tab = flow.tabs.findItem('linker', location.hash.substring(1));
			if (!tab) {
				tab = flow.tabs[0];
				location.hash = tab.linker;
			}

			if (common.tab !== tab) {
				savescrollposition();
				var el = $('.designer-scrollbar');
				var tmp = common.tabscroll['tab' + tab.id];
				el.animate({ scrollLeft: tmp ? tmp.x : 0, scrollTop: tmp ? tmp.y : 0 }, 300);
				setTimeout(function() {
					var tc = $('.tabs-scroller');
					var te = tc.find('a[href="#{0}"]'.format(tab.linker));
					te[0].scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'nearest' });
				}, 800);
			}

			SET('common.tab', tab);
			flow.designer = [];
			flow.instances = {};

			flow.components.forEach(function(item) {
				flow.instances[item.id] = item;
				item.tab === common.tab.id && flow.designer.push(item);
			});

			UPDATE('flow.designer');
			setTimeout(function() {
				refreshTrafficNodes();
				refreshTraffic();
			}, 100);
		});

		ON('designer.component.io', function(comid, type, io_index, enable) {
			SETTER('websocket', 'send', { target: comid, type: 'io', io: type, index: io_index, enable: enable });
		});

		$(window).on('hashchange', function() {
			EMIT('designer.selectable', null);
			EMIT('designer.refresh');
		}).trigger('hashchange');

		$(document).on('dblclick', '.tab', function() {
			EMIT('tabs.upd', this.getAttribute('data-id'));
		});

		$(window).on('keydown', function(e) {
			if (e.target.tagName === 'BODY' && !common.form) {

				if (e.keyCode === 13 && (e.ctrlKey || e.metaKey))
					EMIT('flow.apply');

				if (flow.selected && flow.selected.length) {
					// ctrl+d
					if (e.keyCode === 68 && (e.ctrlKey || e.metaKey)) {
						e.preventDefault();
						EMIT('designer.duplicate');
						return;
					}
					// ctrl+c
					if (e.keyCode === 67 && (e.ctrlKey || e.metaKey)) {
						e.preventDefault();
						EMIT('designer.copy', e.shiftKey);
						return;
					}
				}
				// ctrl+v
				if (flow.clipboard && e.keyCode === 86 && (e.ctrlKey || e.metaKey)) {
					e.preventDefault();
					EMIT('designer.paste');
				}
			}
		});

		function settings_component() {
			id = flow.selected[0].attrd('id');
			EMIT('designer.settings', id);
		}

		ON('flow.clear', function() {
			SETTER('confirm', 'confirm', '@(Are you sure you want to clear your current workflow in current tab?)', ['"trash-o" @(Yes)', '@(Cancel)'], function(index) {
				if (index)
					return;
				flow.components = flow.components.remove(function(comp){
					if (comp.tab === common.tab.id)
						EMIT('changed', 'rem', comp.id);
					return comp.tab === common.tab.id;
				});
				UPDATE('flow');
				SETTER('binder', 'scan');
				EMIT('designer.refresh');
				setState(MESSAGES.apply);
				EMIT('designer.unselect');
			});
		});

		ON('flow.settings', function() {

			var component = flow.components.findItem('id', settings.$id);
			var tmp_d = component.options ? component.options.debug === true : false;
			component.options = settings[component.component];

			var tmp_n = component.name;
			var tmp_r = component.reference;
			var tmp_c = component.color;

			component.name = component.options.NAME;
			component.reference = component.options.REFERENCE;
			component.color = component.options.COLOR;
			component.notes = component.options.NOTES;
			component.options.COMPONENT = undefined;

			EMIT('save.' + component.component, component, component.options);

			var is_designer = tmp_c !== component.color || tmp_n !== component.name || tmp_n !== component.options.NAME || tmp_r !== component.options.REFERENCE || component.output !== settings.$output || component.input !== settings.$input;

			if (component.name !== component.options.NAME)
				component.options.NAME = component.name;

			if (component.reference !== component.options.REFERENCE)
				component.options.REFERENCE = component.reference;

			if (component.color !== component.options.COLOR)
				component.options.COLOR = component.color;

			if (component.notes !== component.options.NOTES)
				component.options.NOTES = component.notes;

			var is_server = is_designer ? true : STRINGIFY(component.options) !== settings.$backup;

			component.options.OUTPUT = component.output;
			component.options.INPUT = component.input;
			component.options.README = undefined;

			if (!component.isnew && is_server) {
				SETTER('websocket', 'send', { target: settings.$id, type: 'options', body: component.options });
				success();
			}

			if (component.output != null) {
				var count = component.output instanceof Array ? component.output.length : component.output;
				Object.keys(component.connections).forEach(function(key) {
					var index = +key;
					index >= count && (delete component.connections[key]);
				});
			}

			if (component.input != null) {
				var count = component.input instanceof Array ? component.input.length : component.input;
				flow.components.forEach(function(item) {
					if (component === item)
						return;
					Object.keys(item.connections).forEach(function(key) {
						item.connections[key] = item.connections[key].remove(function(item) {
							return item.id === component.id && (+item.index) >= count;
						});
						!item.connections[key].length && (delete component.connections[key]);
					});
				});
			}

			setTimeout(function() {
				component.options.NAME = undefined;
				component.options.REFERENCE = undefined;
				component.options.OUTPUT = undefined;
				component.options.INPUT = undefined;
				component.options.COLOR = undefined;
				component.options.NOTES = undefined;
				component.options.README = undefined;
				if (is_designer)
					EMIT('designer.refresh');
				else if ((tmp_d && !component.options.debug) || (!tmp_d && component.options.debug))
					$('.node_' + settings.$id).find('.node_debug').tclass('hidden', !component.options.debug);

			}, 300);

			SET('common.form', '');
		});

		function cleanComponent(id, mov) {
			var obj = flow.components.findItem('id', id);
			if (obj) {
				var comp = CLONE(obj);
				if (mov)
					return { id: id, x: comp.x, y: comp.y };
				comp.$component = undefined;
				comp.changed = undefined;
				comp.isnew = undefined;
				return comp;
			}
		};

		ON('flow.apply', function() {
			SETTER('confirm', 'confirm', '@(Are you sure you want to apply current workflow?)', ['"play-circle" @(APPLY NOW)', '@(Cancel)'], function(index) {

				if (index)
					return;

				flow.crashmode = false;

				$('.node_new').rclass('node_new');
				$('.path_new').rclass('path_new');

				flow.connections = {};

				flow.components.forEach(function(item) {
					item.isnew = undefined;
					item.$component = common.components.findItem('id', item.component);
					Object.keys(item.connections).forEach(function(index) {
						item.connections[index].forEach(function(conn) {
							flow.connections[item.id + '#' + index + '#' + conn.index + '#' + conn.id] = true;
						});
					});
				});

				flow.tabs.forEach(function(item) {
					item.changed = undefined;
				});

				EMIT('apply');
				SETTER('designer', 'animclear');
				$('.tabs-flow').find('.changed').rclass('changed');

				var temp = [];
				var changes = common.changes;

				// changes === { id: [ 'add', 'rem' ]}
				Object.keys(changes).forEach(function(id){
					if (!changes[id])
						return;
					if (~changes[id].indexOf('add'))
						temp.push({ type: 'add', com: cleanComponent(id) });
					else if (~changes[id].indexOf('rem'))
						temp.push({ type: 'rem', id: id });
					else {
						if (~changes[id].indexOf('mov'))
							temp.push({ type: 'mov', com: cleanComponent(id, true) });
						if (~changes[id].indexOf('conn'))
							temp.push({ type: 'conn', id: id, conn: flow.components.findItem('id', id).connections });
					}
				});

				if (common.changedtabs)
					temp.push({ type: 'tabs', tabs: flow.tabs });

				common.changes = {};

				setState('');
				SETTER('websocket', 'send', { type: 'apply', body: temp });
				setTimeout(success, 1000);
				refreshTrafficNodes();
			});
		});

		ON('flow.restore', function() {
			SETTER('confirm', 'confirm', '@(Are you sure you want to refresh this page?)', ['"trash-o" @(Yes)', '@(Cancel)'], function(index) {
				!index && location.reload(true);
			});
		});

		ON('debug.clear', function() {
			$('#body-debug-output').empty();
		});

		// Tabs operations
		ON('tabs.add', function() {

			formtabpositions = [];
			for (var i = 0; i < flow.tabs.length + 1; i++)
				formtabpositions.push({ id: i + 1, name: (i + 1) + '' });

			UPDATE('formtabpositions');
			SET('formtab', { position: flow.tabs.length + 1 }, true);
			SET('common.form', 'tab');
		});

		ON('tabs.upd', function(id) {

			formtabpositions = [];
			for (var i = 0; i < flow.tabs.length; i++)
				formtabpositions.push({ id: i + 1, name: (i + 1) + '' });

			UPDATE('formtabpositions');

			var index = flow.tabs.findIndex('id', id);
			if (index !== -1) {
				var data = CLONE(flow.tabs[index]);
				data.position = index + 1;
				SET('formtab', data, true);
				SET('common.form', 'tab');
			}
		});

		ON('tabs.rem', function(id) {
			flow.components = flow.components.remove(function(comp){
				if (comp.tab === id)
					EMIT('changed', 'rem', comp.id);
				return comp.tab === id;
			});

			SET('flow.tabs', flow.tabs.remove('id', id));
			SETTER('binder', 'scan');
			if (common.tab.id === id && flow.tabs.length)
				location.hash = flow.tabs[0].linker;
			EMIT('designer.unselect');
			setState(MESSAGES.apply, true);
			EMIT('changed', 'tabs');
		});

		ON('tabs.save', function(form) {

			var o = form.id ? flow.tabs.findItem('id', form.id) : {};
			o.name = form.name;
			o.icon = form.icon;
			o.linker = o.name.slug();
			o.changed = true;

			if (!o.linker)
				o.linker = GUID(8);

			if (!o.id) {
				o.id = Date.now().toString();
				flow.tabs.push(o);
			}

 			var linker = flow.tabs.findItem(function(item) {
 				return item.id !== o.id && item.linker === o.linker;
 			});

			if (linker)
				o.linker += GUID(3);

			var position = form.position - 1;

			if (flow.tabs[position] && flow.tabs[position].id !== o.id) {
				flow.tabs = flow.tabs.remove('id', o.id);
				flow.tabs.splice(position, 0, o);
			}

			UPDATE('flow.tabs');
			SETTER('binder', 'scan');
			location.hash = o.linker;
			EMIT('changed', 'tabs');
			setState(MESSAGES.apply, true);
		});

		ON('online', function(online) {
			common.logging && console.log(online ? 'online' : 'offline');
			SETTER('loading', online ? 'hide' : 'show');
		});

		ON('message', function(message) {

			common.logging && console.log('--->', message);

			if (message.type === 'templates') {
				var arr = message.body;
				SET('common.designs', arr);
				return;
			}

			if (message.type === 'template') {
				SETTER('loading', 'show');
				SETTER('loading', 'hide', 3000);
				SET('common.form', 'import');
				SET('formimport.replace', true, 1000);
				setTimeout(function() {
					SETR('formimport.body', message.body);
				}, 2800);
				return;
			}

			if (message.type === 'components') {
				var arr = message.body;
				updateVersions(arr, common.components);
				SET('common.templates', arr);
				return;
			}

			if (message.type === 'componentversion') {
				EXEC('database/version', message.version);
				return;
			}

			if (message.type === 'errors') {
				$('.node_' + message.id).aclass('node_errors');
				var instance = flow.components.findItem('id', message.id);
				instance && (instance.errors = message.body);
				Object.keys(message.body).forEach(function(key) {
					key !== 'error' && $('path[data-from="{0}"]'.format(key)).each(function() {
						var el = $(this);
						el.attrd('to') === message.id && el.aclass('path_error').attr('title', message.body[key]);
					});
				});

				EMIT('errors.refresh');
				return;
			}

			if (message.type === 'traffic') {

				if (document.hidden)
					return;

				common.traffic = message.body;
				refreshTraffic();

				var arr = [];
				var empty = { input: 0, output: 0 };
				var count = message.body.count;

				for (var i = 0, length = flow.components.length; i < length; i++) {
					var component = flow.components[i];
					if (component.$component) {
						if (common.traffictab && common.tab && component.tab !== common.tab.id)
							continue;
						var stats = message.body[component.id] || empty;
						arr.push({ id: component.id, name: component.name || component.$component.name, inputs: stats.input, outputs: stats.output, inputc: stats.input ? (Math.abs(stats.input) + 'x') : '---', outputc: stats.output ? (Math.abs(stats.output) + 'x') : '---', input: ((stats.input / count) * 100 >> 0), output: ((stats.output / count) * 100 >> 0), order: stats.input + stats.output, isduration: !!(component.$component.input && component.$component.output), duration: stats.duration || 0 });
					}
				}

				arr.memory = message.memory;
				arr.counter = message.counter;

				if (common.trafficsort) {
					var name = common.trafficsort;
					var asc = name.substring(0, 1) !== '!';
					if (!asc)
						name = name.substring(1);
					arr.quicksort(name, asc);
				}

				SET('flow.traffic', arr);
				return;
			}

			if (message.type === 'designer') {

				flow = {};
				flow.version = common.version;
				flow.tabs = message.tabs;
				flow.components = message.components;
				flow.designer = [];
				flow.loaded = true;

				if (!flow.tabs) {
					flow.tabs = [{ id: Date.now().toString(), name: '@(Main)', icon: 'fa-object-ungroup', linker: 'main' }];
					 EMIT('changed', 'tabs');
				}

				if (!flow.components)
					flow.components = [];

				flow.connections = {};

				flow.components.forEach(function(item) {
					item.$component = message.database.findItem('id', item.component);
					Object.keys(item.connections).forEach(function(index) {
						item.connections[index].forEach(function(conn) {
							flow.connections[item.id + '#' + index + '#' + conn.index + '#' + conn.id] = true;
						});
					});
				});

				flow.crashmode = message.crashmode;

				if (flow.crashmode) {
					setState(MESSAGES.apply, true);
					SETTER('confirm', 'confirm', '@(<h3 class="nmb red">Crash mode</h3>Flow is in <b>crash mode</b> and data processing is paused. You need to press <b>APPLY</b> for re-init Flow again.)', ['"chevron-right"@(Continue in editing)'], NOOP);
				}

				if (!common.ready) {
					common.ready = true;
					if (!flow.components.length)
						SET('common.form', 'welcome');
				};

				message.database.quicksort('name');
				updateVersions(common.templates, message.database);
				SET('common.components', message.database);
				SET('flow.paused', message.paused === true);

				UPDATE('flow');
				SETTER('binder', 'scan');
				setTimeout(function() {

					EMIT('designer.refresh');

					setTimeout(function() {
						common.components.forEach(function(item) {
							var key = 'extension' + item.component;
							if (item.clientside && !common.statics[key]) {
								common.statics[key] = 1;
								try {
									new Function(item.extension)();
								} catch (e) {
									console && console.error(e);
								}
							}
						});
					}, 500);

				}, common.form === 'database' ? 3000 : 0);
				EMIT('errors.refresh');
				return;
			}

			if (message.type === 'status') {
				if (flow.components) {
					var component = flow.components.findItem('id', message.target);
					if (component) {
						!component.state && (component.state = {});
						component.state.color = message.body.color || 'gray';
						component.state.text = message.body.text;
						$('.node_status_' + message.target).text(component.state.text).attr('fill', component.state.color);
					}
				}
				return;
			}

			if (message.type === 'debug') {
				EMIT('debug', message.id, message.body, message.identificator, message.group, message.time);
				return;
			}

			if (message.type === 'trigger') {
				var trigger = flowtriggers[message.id];
				if (trigger) {
					if (typeof(trigger) === 'function')
						trigger(message.body);
					else
						SET(trigger, message.body);
				}
				return;
			}

			if (message.type === 'callback') {
				var fn = common.callbacks[message.id];
				if (message.id) {
					fn(message.body);
					delete common.callbacks[message.id];
				}
				return;
			}

			if (message.type === 'paused') {
				SET('flow.paused', message.is);
				return;
			}

			if (message.type === 'componentoptions') {
				var component = flow.components.findItem('id', message.id);
				if (component) {

					if (component.color !== message.color) {
						component.color = message.color;
						$('.node_' + message.id).find('rect:first-child').attr('fill', component.color || component.$component.color);
					}

					component.notes = message.notes;

					if (component.name !== message.name)
						component.name = message.name;

					component.options = message.options;
					EMIT('designer.refresh');
				}
			}

			if (message.type === 'error') {
				flownotifications.push(message.body);
				shownotifications();
				return;
			}

			if (message.type === 'variables-error') {
				SETTER('confirm', 'show', '<b class="red">@(Variables parsing error:)</b><br />' + message.body, ['"wrench"@(Fix the problem)', '@(Cancel)'], function(index) {
					index === 1 && SET('common.form', '');
				});
				return;
			}

			if (message.type === 'variables-saved') {
				SETTER('snackbar', 'success', '@(Variables have been saved successfully.)');
				SET('common.form', '');
				return;
			}

			if (message.type === 'variables') {
				SET('formvariables.body', message.body, true);
				return;
			}

			if (message.type === 'clearerrors') {
				$('.node_errors').rclass('node_errors');
				$('.path_error').rclass('path_error').attr('title', '');
				flow.components.forEach(function(instance) {
					instance.errors = {};
				});
				SET('common.errors', EMPTYARRAY);
				return;
			}

			if (message.type === 'online') {
				SET('common.onlineusers', message.count);
				return;
			}

			if (message.type === 'settings') {
				if (message.copyid) {
					var component = flow.components.findItem('id', message.copyid);
					if (component)
						component.options = message.body;
				} else
					showsettings(message.id, message.body);
				return;
			}

			if (message.type === 'export') {

				for (var i = 0; i < flow.components.length; i++) {
					var tmp = flow.components[i];
					if (message.options[tmp.id])
						tmp.options = message.options[tmp.id];
				}

				SET('common.form', 'export');
				return;
			}
		});

		// Prevention for "backspace"
		WATCH('common.form', function(path, value) {
			FIND('designer').disabled = value ? true : false;
		});

		ON('resize', function(w) {
			$('.noscrollbar').each(function() {
				var el = $(this);
				var top = el.offset().top;
				var h = el.closest('.panel,.mainmenu').height();
				el.css('height', h - top);
			});
			setTimeout2('resizetabs', FUNC.resizetabs, 200);
		});

		WATCH('common.minimized', function(path, value) {
			if (value) {
				$('.panel').css('margin-right', -($('.panel').width()));
				$('.body').css('margin-right',0);
			} else {
				$('.panel').css('margin-right', 0);
				$('.body').css('margin-right', $('.panel').width());
			}
		}, true);

		function setState(value, noChange) {
			!noChange && value && changedTab();
			$('#designerstate').html(value);
			$('.mainmenu').find('.highlight').tclass('blink', value ? true : false);
			FUNC.resizetabs();
		}

		function staticContent(target, type, callback) {

			var key = type + '.' + target;

			if (common.statics[key]) {
				callback(common.statics[key], true);
				return;
			}

			var id = GUID(15);

			common.callbacks[id] = function(response) {
				if (type === 'html') {
					common.statics[key] = 'html.' + target;
					var com = common.components.findItem('id', target);
					var title = com ? com.name : target;
					var form = ('<div data-jc-id="html.{0}" data---="form__common.form__title:@(Settings\\:) {2};if:settings-{0};width:960" class="hidden"><div data-jc-scope="settings.{0}"><div><div class="padding bg-fade"><div class="row"><div class="col-md-4 m"><div data---="textbox__NAME__placeholder:@(Type a label for node)">@(Label)</div></div><div class="col-md-4 m"><div data---="textbox__REFERENCE__placeholder:@(Type a reference for this instance)">@(Reference)</div></div><div class="col-md-4 m"><div class="fs12">@(Color:)</div><div data---="colorselector__COLOR"></div></div></div><div data-bind="?.COMPONENT__show:value!==\'debug\'" class="m"><div data---="checkbox__debug">@(Enable console debug)</div></div></div>{1}</div></div><nav><button name="submit" class="exec" data-exec="#flow.settings">@(APPLY SETTINGS)</button><button name="cancel">@(Cancel)</button></nav></div>').format(target, response || '<br /><div class="ui-center padding gray"><i class="fa fa-ban mr5"></i>@(No advanced configuration.)</div><br />', title.replace(/\:/g, '\\:'));
					COMPILE($('#flowsettings').append(form));
				} else
					common.statics[key] = response;
				callback(common.statics[key], false);
			};

			SETTER('websocket', 'send', { id: id, target: target, type: type });
		}

		ON('designer.zoomin', function() {
			SETTER('designer', 'zoom', 1);
		});

		ON('designer.zoomout', function() {
			SETTER('designer', 'zoom', -1);
		});

		ON('designer.zoomreset', function() {
			SETTER('designer', 'zoom', 0);
		});

		ON('designer.remove', function(el) {
			!el.hclass('disabled') && SETTER('designer', 'remove');
		});

		ON('designer.unselect', function() {
			SETTER('designer', 'select', null);
		});

		ON('designer.duplicate', function(shiftKey) {
			EMIT('designer.copy', shiftKey === true ? shiftKey : false);
			EMIT('designer.paste');
		});

		ON('designer.copy', function(el) {

			flow.pasteconnected = false;

			if (el === true) {
				flow.pasteconnected = el;
				el = null;
			}

			if (el && el.hclass('disabled'))
				return;

			if (!flow.selected.length)
				return;

			var ids = flow.selected.map(function(sel){ return sel.attrd('id'); });

			flow.clipboard = flow.components.findAll(function(com) {
				return ids.indexOf(com.id) > -1;
			});

			el && el.aclass('animate');
			setTimeout(function() {
				el && el.rclass('animate');
			}, 500);
			EMIT('designer.selectable', flow.selected);
		});

		function updateVersions(templates, components) {

			if (!templates || !components)
				return;

			for (var i = 0; i < templates.length; i++) {
				var item = templates[i];
				for (var j = 0; j < item.items.length; j++) {
					var subitem = item.items[j];
					subitem.name = subitem.url.substring(subitem.url.lastIndexOf('/') + 1, subitem.url.length - 3);
					var com = components.findItem('id', subitem.name);
					if (com) {
						com.versionrepo = subitem.version;
						com.canupdate = com.version !== com.versionrepo;
					}
				}
			}
		}

		function findBottom() {
			var tab = common.tab.id;
			var bottom = 0;
			if (!flow.components.length)
				return bottom;
			flow.components.forEach(function(c){
				if (common.tab.id === c.tab && c.y > bottom)
					bottom = c.y;
			});
			return !bottom ? 20 : bottom + 100;
		}

		function findOffset() {
			var offset = 0;
			flow.clipboard.forEach(function(c){
				if (!offset)
					return offset = c.y;
				if (c.y < offset)
					offset = c.y;
			});
			return offset;
		}

		function tabscrolling(el) {
			var pos = +el.attrd('value');
			var container = $('.tabs-scroller');
			container.animate({ scrollLeft: container[0].scrollLeft + pos }, 200);
		}

		ON('designer.paste', function(el) {

			if (!flow.clipboard || !flow.clipboard.length || (el && el.hclass('disabled')))
				return;

			SETTER('loading', 'show');

			if (flow.clipboard.length === 1 && flow.pasteconnected) {

				var com = flow.clipboard[0];

				function addToClipboard(com) {
					Object.keys(com.connections).forEach(function(index) {
						com.connections[index].forEach(function(item) {
							var c = flow.components.findItem('id', item.id);
							flow.clipboard.push(c);
							addToClipboard(c);
						});
					});
				};

				addToClipboard(com);
			};

			var bottom = findBottom();
			var offset = findOffset();

			var ids = {};
			var new_comps = [];
			var readsettings = [];

			flow.clipboard.wait(function(component, next, index){

				var obj = CLONE(component);
				var org = component.$component;
				obj.$component = component.$component;
				obj.id = Date.now().toString();

				if (!flow.pasteconnected && component.tab === common.tab.id) {
					obj.y += 50;
					obj.x += 10;
				} else
					obj.y = obj.y - offset + bottom;

				obj.tab = common.tab.id;

				if (typeof(org.status) === 'object')
					obj.state = { text: org.status.text, color: org.status.color };
				else
					obj.state = { text: org.status || '', color: '' };

				obj.parentid = component.id;
				new_comps.push(obj);
				ids[component.id] = obj.id;
				setTimeout(next, 5);

			}, function(){

				flow.pasteconnected = false;

				new_comps.forEach(function(item) {
					Object.keys(item.connections).forEach(function(index) {
						var conns = item.connections[index].filter(function(conn, i) {
							if (ids[conn.id]) {
								conn.id = ids[conn.id];
								return conn;
							}
						});
						if (conns.length)
							item.connections[index] = conns;
						else
							delete item.connections[index];
					});

					item.connections.length && 	item.connections.trim();
					item.isnew = true;
					flow.components.push(item);
					flow.designer.push(item);
					EMIT('add.' + item.component);
					EMIT('changed', 'add', item.id);
				});

				flow.components.wait(function(item, next) {
					if (!item.parentid) {
						next();
						return;
					}
					SETTER('websocket', 'send', { type: 'settings', target: item.parentid, copyid: item.id });
					delete item.parentid;
					setTimeout(next, 100);
				}, function() {
					SETTER('loading', 'hide', 500);
				});

				flow.clipboard = null;
				EMIT('designer.selectable', flow.selected);
				setState(MESSAGES.apply);

				setTimeout(function() {
					EMIT('designer.refresh');
					SETTER('designer', 'selectNew');
				}, 100);
			});
		});

		ON('errors.refresh', function() {
			var errors = [];
			flow.components.forEach(function(instance) {

				if (!instance.errors)
					return;

				var err = [];
				Object.keys(instance.errors).forEach(function(key) {
					err.push(instance.errors[key]);
				});

				err.length && errors.push({ tab: flow.tabs.findItem('id', instance.tab).name, name: instance.name || instance.$component.name, color: instance.$component.color || 'gray', component: instance.$component.name, errors: err });
			});
			SET('common.errors', errors);
		});

		ON('errors.clear', function() {
			SETTER('loading', 'show');
			common.errors && common.errors.length && SETTER('websocket', 'send', { type: 'clearerrors' });
			SETTER('loading', 'hide', 1000);
		});

		function settings_menu(el) {
			var items = [];

			items.push({ name: '@(Components)', icon: 'database', value: 'database' });
			items.push({ name: '@(Variables)', icon: 'sliders', value: 'variables' });
			items.push('-');
			items.push({ name: '@(Export designer)', icon: 'cloud-upload', value: 'export' });
			items.push({ name: '@(Import designer)', icon: 'cloud-download', value: 'import' });
			items.push({ name: '@(Templates)', icon: 'swatchbook', value: 'templates' });
			items.push('-');
			items.push({ name: '@(Clear current tab)', icon: 'trash-o', value: 'clear' });

			@{if helpers.FLOWBOARD || helpers.DASHBOARD}
			items.push('@(Applications)');
			@{if helpers.DASHBOARD}
			items.push({ name: '@(Dashboard)', icon: 'dashboard', url: '@{helpers.DASHBOARD.url}' });
			@{fi}
			@{if helpers.FLOWBOARD}
			items.push({ name: '@(Flowboard)', icon: 'object-group', url: '@{helpers.FLOWBOARD.url}' });
			@{fi}
			@{fi}

			EMIT('settings.open', items);

			var opt = {};
			opt.items = items;
			opt.element = el;
			opt.offsetY = -5;

			opt.callback = function(item) {

				if (item.url) {
					location.href = item.url;
					return;
				}

				var value = item.value;
				EMIT('settings.select', value);

				switch (value) {
					case 'database':
						showcomponents();
						break;
					case 'variables':
					case 'import':
					case 'templates':
						SET('common.form', value);
						return;
					case 'export':
						SETTER('websocket', 'send', { type: 'export' });
						break;
					case 'clear':
						EMIT('flow.clear');
						return;
				}
			};

			SETTER('menu', 'show', opt);
		}

		SETTER(true, 'shortcuts', 'register', 'F1', function(e) {

			var items = [];
			items.push({ name: '@(Templates)', value: 1, icon: 'swatchbook', form: 'templates' });
			items.push({ name: '@(Components)', value: 19, icon: 'database', keywords: 'database', form: 'database' });
			items.push({ name: '@(Variables)', value: 1, icon: 'sliders', form: 'variables' });
			items.push({ name: '@(Console)', value: 3, icon: 'history', keywords: 'debug' });
			items.push({ name: '@(Errors)', value: 4, icon: 'bug', keywords: 'bugs' });
			items.push({ name: '@(Traffic)', value: 5, icon: 'tasks' });
			items.push({ name: '@(Info)', value: 11, icon: 'info-circle' });
			items.push({ name: '@(Toggle tools)', value: 6, icon: 'eye', keywords: 'maximize minimize show hide' });
			items.push({ name: '@(Toggle controls)', value: 7, icon: 'eye', keywords: 'components show hide' });
			items.push({ name: '@(Toggle info)', value: 8, icon: 'eye', keywords: 'show hide' });
			items.push({ name: '@(Apply)', value: 15, icon: 'play-circle', keywords: 'run save' });
			items.push({ name: '@(Export designer)', value: 1, icon: 'copy', form: 'export' });
			items.push({ name: '@(Import design)', value: 1, icon: 'folder-o', form: 'import' });
			items.push({ name: '@(Clear errors)', value: 13, icon: 'trash-o' });
			items.push({ name: '@(Clear console)', value: 14, icon: 'trash-o' });

			if (flow.paused)
				items.push({ name: '@(Start Flow)', value: 18, icon: 'play' });
			else
				items.push({ name: '@(Pause Flow)', value: 18, icon: 'pause' });

			@{if helpers.DASHBOARD}
			items.push({ name: '@(Dashboard)', icon: 'dashboard', value: 9, url: '@{helpers.DASHBOARD.url}' });
			@{fi}
			@{if helpers.FLOWBOARD}
			items.push({ name: '@(Flowboard)', icon: 'object-group', value: 9, url: '@{helpers.FLOWBOARD.url}' });
			@{fi}

			items.push({ name: '@(Create a new tab)', value: 16, icon: 'plus' });

			flow.tabs.forEach(function(item) {
				items.push({ name: '@(Show tab: {0})'.format(item.name), value: 12, icon: 'th-large', tab: item });
			});

			flow.components.forEach(function(item) {
				var tab = flow.tabs.findItem('id', item.tab);
				items.push({ name: '@(Find: {0} (tab: {1}))'.format(item.name || item.component, tab ? tab.name : '???'), keywords: 'component', tab: tab, value: 17, icon: 'sitemap', item: item });
			});

			items.push({ name: '@(Refresh)', value: 10, icon: 'refresh', keywords: 'reload' });
			items.push({ name: '@(Clear current tab)', value: 2, icon: 'trash-o' });

			EMIT('features.open', items);

			SETTER('features', 'show', items, function(item) {

				EMIT('features.select', item);

				switch (item.value) {
					case 1:
						SET('common.form', item.form);
						break;
					case 2:
						EMIT('flow.clear');
						break;
					case 3:
						SET('common.panel', 'debug');
						break;
					case 4:
						SET('common.panel', 'errors');
						break;
					case 5:
						SET('common.panel', 'traffic');
						break;
					case 6:
						var tmp = common.minimized;
						SET('common.minimized', tmp ? false : true);
						SET('common.minimizedmainmenu', tmp ? false : true);
						break;
					case 7:
						SET('common.minimizedmainmenu', !common.minimizedmainmenu);
						break;
					case 8:
						SET('common.minimized', !common.minimized);
						break;
					case 9:
						SETTER('loading', 'show');
						location.href = item.url;
						break;
					case 10:
						SETTER('loading', 'show');
						location.reload(true);
						break;
					case 11:
						SET('common.panel', 'info');
						break;
					case 12:
						location.hash = item.tab.linker;
						break;
					case 13:
						EMIT('errors.clear');
						break;
					case 14:
						EMIT('debug.clear');
						break;
					case 15:
						EMIT('flow.apply');
						break;
					case 16:
						EMIT('tabs.add');
						break;
					case 17:
						highlightcomponent(item.item.id);
						break;
					case 18:
						flowpause();
						break;
					case 19:
						showcomponents();
						break;
				}
			});
		}, true);

		function flowpause() {
			if (flow.paused) {
				SETTER('confirm', 'show', '@(Are you sure you want to <b>start</b> the entire Flow?)', ['"play"@(Start now)', '@(Cancel)'], function(index) {
					!index && SETTER('websocket', 'send', { type: 'pause' });
				});
			} else {
				SETTER('confirm', 'show', '@(Are you sure you want to <b>pause</b> the entire Flow?)', ['"pause"@(Pause now)', '@(Cancel)'], function(index) {
					!index && SETTER('websocket', 'send', { type: 'pause' });
				});
			}
		}

		function flowpausestyle(value) {

			var el = this;

			if (typeof(value) !== 'boolean' || common.ispaused === value)
				return;

			common.ispaused = value;

			if (value) {
				flownotifications.push('@(<b>Flow is paused</b> and it doesn\'t process any data.)');
				shownotifications(true);
			}

			el.tclass('red', value != true);
			el.tclass('green', value == true);
			el.find('.fa').tclass('fa-pause', value != true).tclass('fa-play', value === true);
		}

		function showsettings(id, opt) {
			var component = flow.components.findItem('id', id);
			var model = opt;
			model.NAME = component.name;
			model.COMPONENT = component.component;
			model.COLOR = component.color;
			model.NOTES = component.notes;
			model.REFERENCE = component.reference;
			settings.$output = component.output;
			settings.$input = component.input;
			staticContent(component.component, 'html', function() {
				model.README = markdown(common.statics['readme.' + component.component] || '');
				EMIT('open.' + component.component, component, model);
				SET('settings.' + component.component, model);
				SET('common.form', 'settings-' + component.component);
				RESET('settings.' + component.component + '.*', 500);
				settings.$backup = STRINGIFY(model);
				SETTER('loading', 'hide', 500);
			});
			settings.$id = id;
		}

		function showcomponents() {
			var is = flow.components.findItem('isnew', true) != null;
			if (is) {
				SETTER('confirm', 'show', '@(Installing of new components can remove uninitialized components. Are you sure you want to continue?)', ['@(Yes, continue)', '@(Cancel)'], function(index) {
					!index && SET('common.form', 'database');
				});
			} else
				SET('common.form', 'database');
		}

		WATCH('flow.tabs', function() {
			setTimeout(FUNC.resizetabs, 100);
		});

		function saveMoved(){
			var temp = [];
			var changes = common.changes;

			Object.keys(changes).forEach(function(id){
				if (!changes[id] || !~changes[id].indexOf('mov'))
					return;
				var com = cleanComponent(id, true);
				if (com) {
					temp.push({ type: 'mov', com: com });
					changes[id] = changes[id].remove(c => c === 'mov');
				}
			});

			temp.length && SETTER('websocket', 'send', { type: 'apply', body: temp });
		};

		$(document).on('mouseenter mouseleave', '.tooltip', function(e) {
			if (e.type === 'mouseenter') {
				var el = $(this);
				var opt = {};
				opt.element = el;
				opt.html = el.attrd('tooltip');
				opt.align = 'bottom';
				// opt.timeout = 5000;
				opt.offsetX = 8;
				opt.offsetY = 15;
				SETTER('tooltip', 'show', opt);
			} else
				SETTER('!tooltip', 'hide');
		}).on('mousedown', function() {
			SETTER('!tooltip', 'hide');
		});

		WATCH('common.panel', function() {
			$('.noscrollbar').noscrollbar(true);
		});

	</script>

	@{components('flow')}

</body>
</html>
